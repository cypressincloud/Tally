# Tally - 智能自动记账助手

## 项目简介

**Tally** 是一款基于 Android **无障碍服务 (AccessibilityService)** 技术实现的智能记账应用。它不仅支持传统的手动记账和资产管理，核心亮点在于能够智能识别第三方应用（如微信、支付宝、淘宝、京东、抖音、美团等）的支付与收款场景，自动提取金额并弹出悬浮窗供用户确认，实现“无感”记账。

---

## 🚀 初始化配置与权限说明 (必读)

为了实现自动记账、后台保活以及快捷操作，首次启动应用后，请务必在“系统设置”或应用的“助手管理”页面授予以下核心权限。

### 1. 悬浮窗权限 (显示在其他应用上层)
此权限是 Tally 实现交互和后台存活的关键，主要用于以下三个场景：
* **自动记账悬浮窗**：当识别到支付行为时，在屏幕中央弹出金额确认窗口。
* **控制中心磁贴 (QS Tile)**：通过下拉通知栏的快捷磁贴（"记一笔"）快速唤起记账窗口，无需打开 App。
* **1像素保活窗口**：在屏幕左上角生成一个肉眼不可见的 1x1 像素透明窗口。这是为了提高进程优先级，防止系统在后台误杀服务，确保自动记账随时可用。

### 2. 无障碍服务权限 (Accessibility)
* **用途**：这是实现“屏幕自动记账”的核心。Tally 需要此权限来读取屏幕上的节点信息（仅限金额和“支付成功”等关键字），从而触发自动记账逻辑。
* **保活建议**：由于系统机制，无障碍服务容易被杀后台。建议配合第三方 **“无障碍管理器”** App 使用，以锁定 Tally 的无障碍服务不被系统自动关闭。

### 3. 自启动权限
* **用途**：为了确保在手机重启或长时间待机后，Tally 的服务依然在后台运行，请务必在手机管家/系统设置中允许 Tally **“自启动”** 和 **“后台运行”**。

### 4. 通知权限 (可选)
* **用途**：开启后，通知栏会常驻显示一个“Tally 正在运行”的服务状态通知。
* **测试建议**：主要用于测试软件是否成功在后台存活。如果您确认服务运行稳定，或者觉得通知栏碍眼，**后续可以选择关闭此通知权限**，不会影响记账功能。

---

## 🛠 隐藏功能与手势操作 (Hidden Features)

为了保持界面的极致简洁，Tally 将部分高级设置和工具隐藏在特定的**长按手势**中。请熟知以下操作以解锁完整功能：

### 1. 助手配置与夜间模式 (长按统计页)
* **触发方式**：在 **“统计 (Stats)”** 页面，**长按** 顶部的 **日期范围文字**（例如 “2026年1月” 或 “本周...”）。
* **进入页面**：`AssistantManagerActivity` (助手管理)。
* **功能详情**：
    * **自动记账开关**：一键开启/关闭屏幕监控服务。
    * **退款监听开关**：开启后可监听通知栏的退款消息。
    * **关键字管理**：自定义针对不同 App（微信/支付宝）的识别关键字（如“支付成功”、“已存入零钱”）。
    * **夜间模式切换**：点击切换按钮可在“日间模式”与“夜间模式”之间切换，适配不同光线环境。

### 2. 自动资产设置 (长按资产标题)
此功能用于配置“自动记账”时如何智能匹配资产账户。
* **触发方式**：在 **“资产 (Assets)”** 页面，**长按** 顶部的标题栏文字（**“我的资产”** / **“我的负债”**）。
* **进入页面**：`AutoAssetActivity` (自动资产设置)。
* **功能详情**：
    * **关键字绑定**：您可以为每个资产账户绑定特定的关键字。
    * **智能匹配逻辑**：例如，将“招行”关键字绑定到“招商银行卡”资产。当屏幕上出现“招行”字样时，自动记账悬浮窗会自动选中“招商银行卡”作为扣款账户，无需人工干预。

### 3. 数据备份与恢复 (长按首页标题)
为了防止数据丢失，应用内置了基于文件的备份系统。
* **触发方式**：在 **“记账 (Record)”** 首页，**长按** 顶部的 **月份标题**（例如 “2026年1月”）。
* **弹出菜单**：系统将弹出“数据备份/恢复”选项框。
* **功能详情**：
    * **数据导出 (Backup)**：
        * 系统会将当前的**交易记录 (Transactions)** 和 **资产列表 (Assets)** 打包成 JSON 格式。
        * 文件将以 ZIP 压缩包的形式保存到您指定的文件目录（如 Downloads 文件夹）。
        * 文件名通常包含当前时间戳，便于归档。
    * **数据恢复 (Restore)**：
        * 选择之前导出的 ZIP 备份文件。
        * 系统会自动解析并覆盖/合并当前的数据库记录。**注意：建议在恢复前先备份当前数据。**

### 4. 设为默认扣款账户 (长按资产项)
* **触发方式**：在 **“资产”** 列表页，**长按** 任意一个资产卡片。
* **效果**：该资产背景变色（高亮），即被设为默认。
* **作用**：自动记账和手动记账时，将默认选中该账户。

---

## 核心功能列表

* **全自动屏幕记账**：利用无障碍技术实时分析屏幕节点，自动捕捉交易金额。
* **退款通知监听**：通过通知栏监听服务，自动识别退款信息。
* **资产管理体系**：支持资产、负债、借出三种账户类型，支持关联扣款。
* **可视化统计**：提供周/月/年的收支折线图、饼图及智能消费总结。
* **日历看板**：直观的日历视图，每日收支详情一目了然。
* **加班计算器**：内置工时与时薪计算器，快速记录加班收入。

---

## 隐私声明

**Tally** 承诺：
* **无联网权限**：应用不需要联网权限，所有数据均存储在您的手机本地 SQLite 数据库中。
* **敏感数据保护**：无障碍服务仅用于匹配用户自定义的关键字字样。
