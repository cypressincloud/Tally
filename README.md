# Tally (智能记账助手)

## 📖 简介

**Tally** 是一款纯本地化没有任何联网功能的 Android 记账软件。

它最大的特色在于**“无感记账”**——利用 Android 的无障碍服务与通知监听技术，全自动捕捉微信、支付宝及银行短信的收支信息，实现无感记账。配合高度自由的配置项与本地化数据存储。

---

## 🚀 核心功能特色

### 1. 🤖 极致自动化 (核心)
* **屏幕自动抓取**: 基于 `AutoTrackAccessibilityService`，在支付完成瞬间，自动识别屏幕上的金额与商户，直接弹出记账确认框。
* **通知栏监听**: 通过 `NotificationMonitorService` 监听银行扣款短信及支付App通知，自动生成待确认账单。
* **退款自动追踪**: 专门针对退款消息的监听逻辑，防止“负支出”导致账目不平。
* **1像素保活**: 采用悬浮窗“1像素”技术欺骗系统后台策略，极大提高了自动记账服务的存活率。

### 2. 💰 深度资产管理
* **全资产视图**: 统一管理现金、银行卡、微信余额、支付宝、基金股票等账户。
* **自动资产关联**: 建立 `应用 + 关键字 -> 资产账户` 的绑定规则。
    * *场景举例：设置“微信”应用出现“零钱通”关键字时，自动扣减“微信零钱”账户。*
* **资产流向追踪**: 每一笔交易均可关联具体账户，真实反映净资产变动。

### 3. 📊 数据可视化
* **年度热力图**: 拥有年视图 `YearCalendarActivity`，用颜色深浅直观展示每日消费密度。
* **多维统计**: 提供收支饼图、趋势折线图，支持按周、月、年维度分析。
* **自定义图表标记**: 点击图表节点可查看具体日期的收支详情。

### 4. 🛠️ 高级实用工具
* **加班薪资计算器**: 
    * **逻辑**: 采用**固定时薪**制。用户设定工作日与节假日的每小时工资，记录时长后自动计算加班费。
* **照片凭证系统**: 支持为账单添加照片（小票/实物），并可自定义存储路径，实现数据与影像分离备份。
* **快捷磁贴 (Quick Tile)**: 下拉通知栏即可快速呼出记账窗口，无需打开App。

---

## ⚙️ 详细设置与功能清单

Tally 提供了极高自由度的配置选项，涵盖了从记账逻辑到界面展示的方方面面：

### 1. 🕒 加班设置 (`Overtime Settings`)
* **固定时薪配置**: 分别设置 **工作日时薪** 和 **节假日时薪** (例如：工作日 50元/小时，节假日 80元/小时)。
* **基本工资记录**: 仅作为记录项保存，方便用户核对薪资结构。
* **自动填充**: 记录加班时，App 会根据当前日期（工作日/周末）自动填入对应的时薪标准。

### 2. 🗂️ 分类管理 (`CategorySettingsActivity`)
* **收支分类定制**: 自由添加、删除收入和支出的一级分类。
* **二级分类支持**: 提供“二级分类开关”，开启后**长按**一级分类标签（如“餐饮”），即可添加子分类（如“早餐”、“晚餐”）。

### 3. 🧠 记账助手设置 (`AssistantManagerActivity`)
* **自动记账开关**: 一键控制无障碍服务的启用/禁用。
* **退款监听开关**: 独立控制是否监听退款类通知。
* **资产模块开关**: 可选择隐藏底部的“资产”Tab，适应只需要纯记账的用户。
* **关键字触发管理**: 
    * **精准调教**: 针对特定 App（如微信、支付宝）分别设置“支出”和“收入”的屏幕抓取关键字。
    * *功能：决定了哪些文字出现在屏幕上时会触发自动记账弹窗。*

### 4. 💾 数据备份与恢复 (`BackupManager`)
* **完整备份 (ZIP)**: 导出包含数据库文件和所有图片凭证的压缩包，用于换机迁移。
* **Excel 导出**: 将账单数据导出为 CSV/Excel 表格，方便在 PC 端进行二次分析。
* **数据导入**: 支持从 ZIP 备份包恢复，或从 Excel 文件导入历史数据。
* **外部数据迁移**: 提供 JSON 格式的外部数据导入接口(目前只支持钱迹)。

### 5. 📷 照片备份设置 (`PhotoBackupSettingsActivity`)
* **独立存储**: 开启后，应用内的照片凭证将保存到手机文件系统的指定目录（非应用私有目录）。
* **路径自定义**: 调用系统文件选择器，自由选择照片的保存文件夹（推荐新建文件夹，如 `.TallyPhotos`），防止卸载应用后照片丢失。

### 6. 🔗 自动资产设置 (`AutoAssetActivity`)
* **规则引擎**: 配置 `应用包名` + `关键字` -> `目标资产` 的映射。
* **开关控制**: 一键开启/关闭自动关联功能。

### 7. 🎨 界面与交互 (`Theme & Display`)
* **深色模式**: 支持 浅色 / 深色 / 跟随系统 三种模式。
* **极简模式**: 开启后**隐藏主页顶部的菜单按钮**，界面更清爽。
    * *操作提示：开启后需通过**长按底部“统计”图标**进入设置页。*
* **默认记账页**: 设置点击记账按钮时默认显示的标签页（收入 / 支出 / 加班 / 结余）。
* **货币单位开关**: 开启/关闭金额旁的货币符号显示。

---

## 📂 项目结构概览

    src/main/java/com/example/budgetapp/
    ├── database/                       # 数据库层 (Room框架)
    │   ├── AppDatabase.java            # 数据库入口实例
    │   ├── AssetAccount.java           # 资产账户实体 (Entity)
    │   └── Transaction.java            # 交易记录实体 (Entity)
    ├── service/                        # 核心后台服务
    │   ├── AutoTrackAccessibilityService.java # 无障碍服务 (实现屏幕自动抓取)
    │   ├── NotificationMonitorService.java    # 通知监听服务 (实现短信/推送抓取)
    │   └── QuickAddTileService.java           # 系统快捷设置磁贴 (Quick Settings Tile)
    ├── ui/                             # 界面展示层
    │   ├── AssistantManagerActivity.java # 记账助手与关键字设置页
    │   ├── AutoAssetActivity.java        # 自动资产关联规则设置页
    │   ├── CategorySettingsActivity.java # 分类管理页
    │   ├── PhotoBackupSettingsActivity.java # 照片备份路径设置页
    │   ├── SettingsActivity.java         # 应用总设置页
    │   ├── YearCalendarActivity.java     # 年度热力图 Activity
    │   ├── RecordFragment.java           # 首页记账 Fragment
    │   ├── StatsFragment.java            # 统计图表 Fragment
    │   └── AssetsFragment.java           # 资产管理 Fragment
    ├── util/                           # 工具类库
    │   ├── AssistantConfig.java          # SharedPreferences 配置封装
    │   ├── AutoAssetManager.java         # 自动资产关联逻辑引擎
    │   ├── CategoryManager.java          # 收支分类管理工具
    │   ├── ExternalImportHelper.java     # 外部数据导入解析器
    │   └── KeywordManager.java           # 关键字匹配与管理工具
    ├── viewmodel/                      # MVVM ViewModel
    │   └── FinanceViewModel.java         # UI 数据状态管理
    ├── BackupManager.java              # 数据备份、恢复、Excel导出逻辑
    └── MainActivity.java               # 应用主入口

---

## 🛡️ 关键权限说明

为了实现自动化记账，本应用需要申请以下敏感权限。**所有数据仅保存在本地，绝无上传行为。**

### 1. 无障碍服务 (Accessibility Service)
* **用途**: 读取屏幕上的支付结果（金额、商户），实现“无感记账”。
* **设置**: 系统设置 -> 辅助功能 -> 开启“记账屏幕同步助手”。

### 2. 通知使用权 (Notification Access)
* **用途**: 监听银行短信、支付App推送通知，解析消费信息。
* **设置**: 系统设置 -> 通知使用权 -> 允许 Tally。

### 3. 悬浮窗权限 (System Alert Window)
* **用途**: 
    1. 识别到账单时，直接在当前页面弹出确认框。
    2. **1像素保活**: 在屏幕边缘生成不可见悬浮窗，欺骗系统后台策略，防止服务被杀。
* **设置**: 应用详情 -> 权限 -> 允许“显示在其他应用上层”。

### 4. 存储权限 (Storage / Document Tree)
* **用途**: 用于导出备份文件、保存账单图片到用户指定的公开目录。

### 5. 自启动权限
* **用途**: 确保手机重启或后台清理后，自动记账服务能自动恢复运行。

---

## 📝 开发与贡献

1. **环境**: Android Studio Ladybug | 2024.2.1 及以上。
2. **构建**: Gradle 8.x, JDK 17。
3. **运行**: 
    * **重要**：安装后请务必按照上述“权限说明”授予所有权限以体验完整功能。

---

具体更新日志, 酷安搜索"Tally"
